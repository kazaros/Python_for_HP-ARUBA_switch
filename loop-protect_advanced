# скрипт только генерит строки конфига (но легко докрутить, чтобы сам настраивал)
# - порты в сторону ПК/принтеров/WiFi и прочих оконечных устройств будут выключаться
# - порты в сторону других коммутаторов будут только логгировать о петле

from netmiko import ConnectHandler
import textfsm
import re
from ntc_templates.parse import parse_output
import json


with open("/NETWORK_TEST/iplist") as f:
    devices_list = f.read().splitlines()

for devices in devices_list:
    ip_address_of_device = devices
    HP = {
        'device_type':'hp_procurve',
        'ip':ip_address_of_device,
        'username':'111111111',
        'password':'11111111111',
    }
    net_connect = ConnectHandler(**HP)
    print('conncet to ',devices)
    output = net_connect.send_command("show int brief")
    lines = output.count('\n')
#    print (lines)
    if lines > 55:
       print ('Interface_48')
       numbers_ports_All = str(48)
       numbers_ports = int(49)
    elif lines > 31:
       print ('Interface_24')
       numbers_ports_All = str(24)
       numbers_ports = int(25)
    elif lines > 19:
       print ('Interface_16')
       numbers_ports_All = str(16)
       numbers_ports = int(17)
    elif lines > 12:
       print ('Interface_8')
       numbers_ports_All = str(8)
       numbers_ports = int(9)
    print('configure')
    print('loop-protect disable-timer 900')
    print('loop-protect 1-'+numbers_ports_All+' receiver-action send-recv-dis')
    for i in range(1, numbers_ports):
       ports = str(i)
       output = net_connect.send_command('show lldp info remote-device ethernet '+ports)
       try:
          Neighbors_parsed = parse_output(platform="hp_procurve", command='show lldp info remote-device ethernet '+ports, data=output)
          for row in Neighbors_parsed:
              op = json.dumps(row)
              regex_num = re.findall(r'system_descr+.{2,}Switch', op)
              if regex_num != []:
                 print('loop-protect '+ports+' receiver-action no-disable')
       except Exception:
           pass
